<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&display=swap"
      rel="stylesheet"
    />
    <title>CobblePulse</title>
    <style>
      /* --- GOOGLE FONTS IMPORT --- */
      @import url("https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&display=swap");

      /* --- CSS VARIABLES & THEME --- */
      :root {
        --bg-gradient: radial-gradient(
          circle at top right,
          #1a1a2e,
          #16213e,
          #0f3460
        );
        --glass-bg: rgba(22, 33, 62, 0.7);
        --glass-border: rgba(255, 255, 255, 0.1);
        --accent-primary: #e94560;
        --accent-secondary: #0f3460;
        --text-main: #f5f5f5;
        --text-muted: #a0a0b5;
        --blur: blur(12px);
      }

      /* --- TYPE COLORS --- */
      .type-normal {
        background: #a8a878;
        color: #fff;
      }
      .type-fire {
        background: #f08030;
        color: #fff;
      }
      .type-water {
        background: #6890f0;
        color: #fff;
      }
      .type-grass {
        background: #78c850;
        color: #fff;
      }
      .type-electric {
        background: #f8d030;
        color: #000;
      }
      .type-ice {
        background: #98d8d8;
        color: #000;
      }
      .type-fighting {
        background: #c03028;
        color: #fff;
      }
      .type-poison {
        background: #a040a0;
        color: #fff;
      }
      .type-ground {
        background: #e0c068;
        color: #000;
      }
      .type-flying {
        background: #a890f0;
        color: #fff;
      }
      .type-psychic {
        background: #f85888;
        color: #fff;
      }
      .type-bug {
        background: #a8b820;
        color: #fff;
      }
      .type-rock {
        background: #b8a038;
        color: #fff;
      }
      .type-ghost {
        background: #705898;
        color: #fff;
      }
      .type-dragon {
        background: #7038f8;
        color: #fff;
      }
      .type-dark {
        background: #705848;
        color: #fff;
      }
      .type-steel {
        background: #b8b8d0;
        color: #000;
      }
      .type-fairy {
        background: #ee99ac;
        color: #000;
      }

      /* --- RESET & BASE --- */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg-gradient);
        background-attachment: fixed;
        color: var(--text-main);
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 10px;
      }
      ::-webkit-scrollbar-track {
        background: #16213e;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--accent-secondary);
        border-radius: 5px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--accent-primary);
      }

      /* --- LAYOUT COMPONENTS --- */
      .glass-panel {
        background: var(--glass-bg);
        backdrop-filter: var(--blur);
        -webkit-backdrop-filter: var(--blur);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      /* --- HEADER & TITLE --- */
      @keyframes pulse-glow {
        0% {
          text-shadow: 0 0 5px rgba(233, 69, 96, 0.2);
        }
        50% {
          text-shadow:
            0 0 15px rgba(233, 69, 96, 0.6),
            0 0 25px rgba(233, 69, 96, 0.2);
        }
        100% {
          text-shadow: 0 0 5px rgba(233, 69, 96, 0.2);
        }
      }

      header {
        padding: 20px;
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        align-items: center;
        justify-content: space-between;
      }

      header h1 {
        font-family: "Orbitron", sans-serif;
        letter-spacing: 2px;
        font-weight: 900;
        font-size: 2.8rem;
        background: linear-gradient(to right, #ffffff, var(--accent-primary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: pulse-glow 3s infinite ease-in-out;
        margin-bottom: 5px;
      }

      /* Controls (Search & Filter) */
      .controls {
        display: flex;
        gap: 15px;
        flex-grow: 1;
        justify-content: flex-end;
      }

      input,
      select {
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid var(--glass-border);
        background: rgba(0, 0, 0, 0.2);
        color: var(--text-main);
        font-size: 1rem;
        outline: none;
      }

      input:focus,
      select:focus {
        border-color: var(--accent-primary);
      }

      select option {
        background: #1a1a2e;
        color: #fff;
      }

      /* --- TABS --- */
      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        overflow-x: auto;
        padding-bottom: 5px;
      }

      .tab-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--glass-border);
        color: var(--text-muted);
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
      }

      .tab-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-main);
      }

      .tab-btn.active {
        background: var(--accent-primary);
        color: #fff;
        border-color: var(--accent-primary);
      }

      /* --- MAIN UI - TABLE --- */
      .table-container {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        text-align: left;
      }

      th,
      td {
        padding: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      /* Fixed Column Widths for a cleaner layout */
      th:nth-child(1),
      td:nth-child(1) {
        width: 15%;
        min-width: 100px;
      }
      th:nth-child(2),
      td:nth-child(2) {
        width: 10%;
        min-width: 70px;
      }
      th:nth-child(3),
      td:nth-child(3) {
        width: 45%;
      }
      th:nth-child(4),
      td:nth-child(4) {
        width: 30%;
      }

      th {
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.9rem;
      }

      tr {
        transition: background 0.2s;
        cursor: pointer;
      }

      tr:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .sprite-cell img {
        width: 50px;
        height: 50px;
        image-rendering: pixelated;
      }

      .type-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
        margin-right: 5px;
        text-transform: capitalize;
      }

      .loading {
        text-align: center;
        padding: 50px;
        color: var(--text-muted);
        font-size: 1.2rem;
      }

      /* --- MODAL OVERLAY --- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        z-index: 1000;
        padding: 20px;
      }

      .modal-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }

      .modal-content {
        width: 100%;
        max-width: 600px;
        padding: 30px;
        position: relative;
        transform: translateY(20px);
        transition: transform 0.3s ease;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-overlay.active .modal-content {
        transform: translateY(0);
      }

      .close-btn {
        position: absolute;
        top: 15px;
        right: 20px;
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 1.5rem;
        cursor: pointer;
        transition: color 0.2s;
      }

      .close-btn:hover {
        color: var(--accent-primary);
      }

      /* --- MODAL HEADER & CONTENT --- */
      .modal-header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 25px;
        border-bottom: 1px solid var(--glass-border);
        padding-bottom: 20px;
      }

      .modal-sprite {
        width: 120px;
        height: 120px;
        image-rendering: pixelated;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 50%;
      }

      .modal-title h2 {
        font-size: 2rem;
        text-transform: capitalize;
        margin-bottom: 5px;
      }

      .tier-badge {
        background: var(--accent-secondary);
        color: #fff;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        vertical-align: middle;
        margin-left: 10px;
      }

      .modal-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .info-card {
        background: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid var(--glass-border);
      }

      .info-card h4 {
        color: var(--text-muted);
        font-size: 0.85rem;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .full-width {
        grid-column: 1 / -1;
      }

      /* --- SMOGON INTERACTIVE CONTAINER --- */
      .smogon-container {
        border-radius: 12px;
        padding: 10px;
        margin: -10px;
        transition: all 0.3s ease;
      }

      /* --- SOURCES FOOTER --- */
      .footer-sources {
        text-align: center;
        margin-top: 40px;
        padding: 20px;
        border-top: 1px solid var(--glass-border);
        color: var(--text-muted);
        font-size: 0.85rem;
        letter-spacing: 1px;
        text-transform: uppercase;
      }

      .footer-sources a {
        color: var(--accent-primary);
        text-decoration: none;
        margin: 0 8px;
        font-weight: bold;
        transition: all 0.2s ease;
      }

      .footer-sources a:hover {
        color: #fff;
        text-shadow: 0 0 8px var(--accent-primary);
      }

      /* --- RESPONSIVE DESIGN --- */
      @media (max-width: 600px) {
        .controls {
          flex-direction: column;
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container" id="app">
      <header>
        <h1>CobblePulse</h1>

        <div class="controls">
          <input
            type="text"
            id="searchInput"
            placeholder="Search by name or Dex ID..."
          />
          <select id="typeFilter">
            <option value="all">All Types</option>
          </select>
        </div>
      </header>

      <div class="tabs" id="tabContainer">
        <button class="tab-btn" data-tab="ubers">Ubers</button>
        <button class="tab-btn" data-tab="ou">OU</button>
        <button class="tab-btn" data-tab="uu">UU</button>
        <button class="tab-btn" data-tab="ru">RU</button>
        <button class="tab-btn active" data-tab="all">All Cobblemon</button>
      </div>

      <div class="glass-panel table-container">
        <table>
          <thead>
            <tr>
              <th>Rank / Dex #</th>
              <th>Sprite</th>
              <th>Name</th>
              <th>Types</th>
            </tr>
          </thead>
          <tbody id="pokemonList">
            <tr>
              <td colspan="4" class="loading">Loading Pok√©dex Data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
      <div class="modal-content glass-panel" id="modalContent">
        <button class="close-btn" id="closeBtn">&times;</button>
        <div id="modalBody"></div>
      </div>
    </div>

    <script>
      // --- STATE ---
      let allPokemon = [];
      let localDB = {};
      let currentTab = "all";

      const DOM = {
        list: document.getElementById("pokemonList"),
        searchInput: document.getElementById("searchInput"),
        typeFilter: document.getElementById("typeFilter"),
        tabs: document.querySelectorAll(".tab-btn"),
        modalOverlay: document.getElementById("modalOverlay"),
        modalBody: document.getElementById("modalBody"),
        closeBtn: document.getElementById("closeBtn"),
      };

      const POKEMON_TYPES = [
        "normal",
        "fire",
        "water",
        "grass",
        "electric",
        "ice",
        "fighting",
        "poison",
        "ground",
        "flying",
        "psychic",
        "bug",
        "rock",
        "ghost",
        "dragon",
        "dark",
        "steel",
        "fairy",
      ];

      async function init() {
        populateTypeFilter();
        setupEventListeners();

        try {
          // Only fetch your local database - it has everything!
          const dbResponse = await fetch("./localDB.json");
          window.localDB = await dbResponse.json();

          // Directly render using your local data
          renderTable();
        } catch (e) {
          console.error("Data load failed. Make sure localDB.json exists.", e);
        }
      }

      async function fetchAllPokemon() {
        try {
          // Increased limit to 1300 to catch forms like Calyrex-Shadow (ID 10194)
          const response = await fetch(
            "https://pokeapi.co/api/v2/pokemon?limit=1300",
          );
          const data = await response.json();

          allPokemon = data.results.map((p) => {
            // Safely extract the true ID from the URL (Fixes the 10000+ ID issue)
            const urlParts = p.url.split("/");
            const id = parseInt(urlParts[urlParts.length - 2]);

            // Matches the exact cleaning logic your compiler uses!
            const cleanName = p.name.toLowerCase().replace(/[^a-z0-9]/g, "");

            return {
              id: id,
              name: p.name,
              cleanName: cleanName,
              sprite: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`,
              types: [],
            };
          });
        } catch (error) {
          DOM.list.innerHTML = `<tr><td colspan="4" class="loading">Error loading PokeAPI data.</td></tr>`;
        }
      }

      async function getPokemonDetails(id) {
        const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
        return await res.json();
      }

      // --- HELPER: BUILD SPREADSHEET LOCATION UI ---
      function buildLocationCards(locations, title) {
        const cards = locations
          .map((loc) => {
            const conditionHtml = loc.condition
              ? `<div style="margin-top: 6px; color: var(--accent-primary);">‚ö†Ô∏è Condition: ${loc.condition}</div>`
              : "";
            const formsHtml = loc.forms
              ? `<div style="margin-top: 4px; color: #a8a878;">‚ú® Form Info: ${loc.forms}</div>`
              : "";

            return `
                  <div style="background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-left: 3px solid var(--accent-primary); padding: 12px; border-radius: 6px; font-size: 0.9rem; margin-bottom: 8px;">
                      <div style="font-weight: bold; color: var(--text-main); margin-bottom: 6px; font-size: 1rem;">üåç ${loc.spawn}</div>
                      <div style="display: flex; flex-wrap: wrap; gap: 12px; color: var(--text-muted);">
                          <span style="background: rgba(255,255,255,0.05); padding: 2px 8px; border-radius: 4px;">üéØ Rarity: <strong>${loc.rarity}</strong></span>
                      </div>
                      ${conditionHtml}
                      ${formsHtml}
                  </div>
                  `;
          })
          .join("");

        return `
                  <h4 style="color: var(--accent-primary); margin-bottom: 12px; margin-top: 15px;">${title}</h4>
                  <div style="max-height: 250px; overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column;">
                      ${cards}
                  </div>
              `;
      }

      async function renderTable(pokemonArray) {
        DOM.list.innerHTML = `<tr><td colspan="4" class="loading">Loading All Pok√©mon...</td></tr>`;

        let html = "";
        for (let i = 0; i < pokemonArray.length; i++) {
          const p = pokemonArray[i];

          if (p.types.length === 0) {
            try {
              const details = await getPokemonDetails(p.id);
              p.types = details.types.map((t) => t.type.name);
            } catch (e) {
              p.types = ["normal"];
            }
          }

          const typeHtml = p.types
            .map((t) => `<span class="type-badge type-${t}">${t}</span>`)
            .join("");
          const dbEntry = localDB[p.cleanName] || localDB[p.name] || {};

          // FIX: Look inside allRanks to find the correct rank for the table!
          let rank = 0;
          if (currentTab !== "all" && dbEntry.allRanks) {
            const tierData = dbEntry.allRanks.find((r) =>
              r.tier.toLowerCase().includes(currentTab.replace("s", "")),
            );
            if (tierData) rank = tierData.rank;
          }

          const isCompetitiveTab = currentTab !== "all";
          const rankText = isCompetitiveTab ? `Rank #${rank}` : `Dex #${p.id}`;
          const rankColor = isCompetitiveTab
            ? "var(--accent-primary)"
            : "var(--text-muted)";

          html += `
            <tr onclick="openModal(${p.id}, '${p.cleanName}')">
                <td><strong style="color: ${rankColor};">${rankText}</strong></td>
                <td class="sprite-cell"><img src="${p.sprite}" alt="${p.name}" loading="lazy"></td>
                <td style="text-transform: capitalize; font-weight: bold;">${p.name.replace("-", " ")}</td>
                <td>${typeHtml}</td>
            </tr>
          `;
        }

        if (pokemonArray.length === 0) {
          html = `<tr><td colspan="4" class="loading">No Pok√©mon found.</td></tr>`;
        }

        DOM.list.innerHTML = html;
      }

      function applyFilters() {
        const query = DOM.searchInput.value.toLowerCase();
        const typeFilter = DOM.typeFilter.value;

        let filtered = [];

        if (currentTab === "all") {
          filtered = allPokemon;
        } else {
          // 1. Filter to current tier
          filtered = allPokemon.filter((p) => {
            const dbEntry = localDB[p.cleanName] || localDB[p.name];
            if (!dbEntry || !dbEntry.allRanks) return false;
            return dbEntry.allRanks.some(
              (r) =>
                r.tier.toLowerCase() === currentTab ||
                (currentTab === "ubers" && r.tier.toLowerCase() === "uber"),
            );
          });

          // 2. Sort mathematically by Rank
          filtered.sort((a, b) => {
            const entryA = (
              localDB[a.cleanName] || localDB[a.name]
            ).allRanks.find((r) =>
              r.tier.toLowerCase().includes(currentTab.replace("s", "")),
            );
            const entryB = (
              localDB[b.cleanName] || localDB[b.name]
            ).allRanks.find((r) =>
              r.tier.toLowerCase().includes(currentTab.replace("s", "")),
            );
            return (entryA?.rank || 999) - (entryB?.rank || 999);
          });

          // 3. APPLY TOP 50 LIMIT (Only for tier tabs)
          filtered = filtered.slice(0, 50);
        }

        // 4. Handle Search Query
        if (query) {
          filtered = filtered.filter((p) => {
            const dbEntry = localDB[p.cleanName] || localDB[p.name] || {};
            const source = (dbEntry.source || "").toLowerCase();
            return (
              p.name.includes(query) ||
              p.id.toString() === query ||
              source.includes(query)
            );
          });
        }

        // 5. Handle Type Filter
        if (typeFilter !== "all") {
          filtered = filtered.filter(
            (p) => p.types.includes(typeFilter) || p.types.length === 0,
          );
        }

        renderTable(filtered);
      }

      function populateTypeFilter() {
        POKEMON_TYPES.forEach((type) => {
          const option = document.createElement("option");
          option.value = type;
          option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
          DOM.typeFilter.appendChild(option);
        });
      }

      // --- MODAL WITH REDESIGNED GRID ---
      async function openModal(id, cleanName) {
        DOM.modalOverlay.classList.add("active");
        DOM.modalBody.innerHTML = `<div class="loading">Fetching Data...</div>`;

        try {
          const details = await getPokemonDetails(id);

          // FIX: We MUST use the species URL provided inside 'details'.
          // Guessing the URL with the ID will crash on any Pok√©mon with an ID over 10000!
          const speciesRes = await fetch(details.species.url);
          const speciesData = await speciesRes.json();

          const dbEntry = localDB[cleanName] ||
            localDB[details.name] || { tier: "Untiered", locations: [] };
          const typeHtml = details.types
            .map(
              (t) =>
                `<span class="type-badge type-${t.type.name}">${t.type.name}</span>`,
            )
            .join("");

          // --- 1. COMPETITIVE LAYOUT ---
          // --- 1. COMPETITIVE LAYOUT (WITH STRATEGIES DROPDOWN) ---
          let stats = null;
          if (dbEntry.allRanks && dbEntry.allRanks.length > 0) {
            if (currentTab === "all") {
              stats = dbEntry.allRanks.reduce((prev, current) =>
                parseFloat(prev.usage) > parseFloat(current.usage)
                  ? prev
                  : current,
              );
            } else {
              stats =
                dbEntry.allRanks.find((r) =>
                  r.tier.toLowerCase().includes(currentTab.replace("s", "")),
                ) || dbEntry.allRanks[0];
            }
          }

          let compHtml = "";
          let hasStrategies =
            stats && stats.strategies && stats.strategies.length > 0;

          if (hasStrategies) {
            const smogonName = details.name.replace("-", "_");
            window.smogonUrl = `https://www.smogon.com/dex/sv/pokemon/${smogonName}/`;
            window.currentStrategies = stats.strategies;
            window.currentUsage = stats.usage;

            // Build the Dropdown UI
            let dropdownHtml = "";
            if (stats.strategies.length > 1) {
              dropdownHtml = `
                          <div style="margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;">
                              <span style="color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; font-weight: bold;">Select Strategy:</span>
                              <select onchange="renderStrategyView(this.value)" style="background: rgba(0,0,0,0.4); border: 1px solid var(--accent-primary); color: #fff; padding: 6px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; max-width: 60%; outline: none;">
                                  ${stats.strategies.map((s, i) => `<option value="${i}">${s.name}</option>`).join("")}
                              </select>
                          </div>
                      `;
            } else {
              dropdownHtml = `
                          <div style="margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;">
                              <span style="color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; font-weight: bold;">Strategy:</span>
                              <span style="color: var(--accent-primary); font-weight: bold; background: rgba(233, 69, 96, 0.1); padding: 4px 10px; border-radius: 6px;">${stats.strategies[0].name}</span>
                          </div>
                      `;
            }

            compHtml = `
                      <div class="info-card full-width" style="margin-bottom: 20px; border-color: var(--accent-primary);">
                          ${dropdownHtml}
                          <div id="dynamic-strategy-content">
                              </div>
                      </div>
                  `;
          } else {
            compHtml = `
                  <div class="info-card full-width" style="margin-bottom: 20px; text-align: center; padding: 20px;">
                      <p style="color: var(--text-muted);">No competitive Smogon data available for this Pok√©mon.</p>
                  </div>`;
          }

          // --- 2. BUILD LOCATION HTML ---
          let locationsHtml = "";
          const hasOwnSpawns =
            dbEntry.locations && dbEntry.locations.length > 0;

          if (hasOwnSpawns) {
            locationsHtml += buildLocationCards(
              dbEntry.locations,
              "üìç Server Spawn Locations",
            );
          }

          if (
            !hasOwnSpawns &&
            (speciesData.is_legendary || speciesData.is_mythical)
          ) {
            locationsHtml += `
                      <div style="background: rgba(233, 69, 96, 0.1); border: 1px solid var(--accent-primary); padding: 15px; border-radius: 8px; margin-top: 10px;">
                          <h4 style="color: var(--accent-primary); margin-bottom: 8px;">‚ú® Legendary Summoning</h4>
                          <p style="color: var(--text-main); font-size: 0.95rem; line-height: 1.4;">This Pok√©mon does not spawn naturally in the wild. You must use a specialized summoning item at an altar, or participate in a server event.</p>
                      </div>
                  `;
          } else if (speciesData.evolves_from_species) {
            const chainRes = await fetch(speciesData.evolution_chain.url);
            const chainData = await chainRes.json();
            const baseEvoName = chainData.chain.species.name;
            const cleanBaseEvoName = baseEvoName.replace("-", "");
            const baseEvoDb = localDB[cleanBaseEvoName] || localDB[baseEvoName];

            if (
              baseEvoDb &&
              baseEvoDb.locations &&
              baseEvoDb.locations.length > 0
            ) {
              const title = hasOwnSpawns
                ? `üí° Easier to catch base form: ${baseEvoName.toUpperCase()}`
                : `üß¨ Evolves from ${baseEvoName.toUpperCase()} (Spawns Below)`;
              locationsHtml += buildLocationCards(baseEvoDb.locations, title);
            } else if (!hasOwnSpawns) {
              locationsHtml += `<p style="color: var(--text-muted); margin-top: 10px;">Must be evolved from <strong>${baseEvoName.toUpperCase()}</strong>. No wild spawns found.</p>`;
            }
          } else if (!hasOwnSpawns) {
            locationsHtml +=
              '<p style="color: var(--text-muted); margin-top: 10px;">No wild spawns found on this server.</p>';
          }

          // --- 3. FINAL INJECTION ---
          const pokemonDbUrl = `https://pokemondb.net/pokedex/${details.name}`;
          const sourceTag = dbEntry.source
            ? `<span style="font-size: 0.7rem; color: var(--text-muted); opacity: 0.6; margin-left: 8px; text-transform: uppercase; letter-spacing: 1px;">[Source: ${dbEntry.source}]</span>`
            : "";

          const currentBadge = stats ? stats.tier.toUpperCase() : "UNTIERED";

          // NEW: Creates the Usage Badge for the header!
          const usageBadge = stats
            ? `<span class="tier-badge" style="background: var(--accent-primary); margin-left: 8px;">${stats.usage}% USAGE</span>`
            : "";

          DOM.modalBody.innerHTML = `
            <div class="modal-header">
                <img src="${details.sprites.front_default}" alt="${details.name}" class="modal-sprite">
                <div class="modal-title">
                    <h2 style="margin-bottom: 5px; display: flex; align-items: center; flex-wrap: wrap;">
                        <a href="${pokemonDbUrl}" target="_blank" title="View on PokemonDB" 
                           style="color: var(--text-main); text-decoration: none; transition: color 0.2s;">
                           ${details.name.replace("-", " ")}
                        </a>
                        <span class="tier-badge">${currentBadge}</span>
                        ${usageBadge}
                        
                        ${sourceTag}
                    </h2>
                    <div style="margin-top: 5px;">${typeHtml}</div>
                </div>
            </div>
            <div>
                ${compHtml}
                <div class="info-card full-width" style="border-color: var(--accent-primary);">
                    ${locationsHtml}
                </div>
            </div>
        `;
          if (hasStrategies) {
            renderStrategyView(0);
          }
        } catch (e) {
          console.error(e);
          DOM.modalBody.innerHTML = `<div class="loading" style="color: var(--accent-primary);">Failed to load details.<br><span style="font-size: 0.8rem; color: var(--text-muted);">${e.message}</span></div>`;
        }
      }

      function closeModal() {
        DOM.modalOverlay.classList.remove("active");
      }

      function setupEventListeners() {
        let timeout = null;
        DOM.searchInput.addEventListener("input", () => {
          clearTimeout(timeout);
          timeout = setTimeout(applyFilters, 300);
        });

        DOM.typeFilter.addEventListener("change", applyFilters);

        DOM.tabs.forEach((tab) => {
          tab.addEventListener("click", (e) => {
            DOM.tabs.forEach((t) => t.classList.remove("active"));
            e.target.classList.add("active");
            currentTab = e.target.getAttribute("data-tab");
            applyFilters();
          });
        });

        DOM.closeBtn.addEventListener("click", closeModal);
        DOM.modalOverlay.addEventListener("click", (e) => {
          if (e.target === DOM.modalOverlay) closeModal();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeModal();
        });
      }

      init();

      const TYPE_CHART = {
        normal: { ghost: 0, fighting: 2 },
        fire: {
          fire: 0.5,
          water: 2,
          grass: 0.5,
          ice: 0.5,
          ground: 2,
          rock: 2,
          bug: 0.5,
          steel: 0.5,
          fairy: 0.5,
        },
        water: {
          fire: 0.5,
          water: 0.5,
          grass: 2,
          electric: 2,
          ice: 0.5,
          steel: 0.5,
        },
        grass: {
          fire: 2,
          water: 0.5,
          grass: 0.5,
          electric: 0.5,
          ice: 2,
          poison: 2,
          ground: 0.5,
          flying: 2,
          bug: 2,
        },
        electric: { electric: 0.5, ground: 2, flying: 0.5, steel: 0.5 },
        ice: { fire: 2, water: 1, ice: 0.5, fighting: 2, rock: 2, steel: 2 },
        fighting: {
          flying: 2,
          psychic: 2,
          bug: 0.5,
          rock: 0.5,
          dark: 0.5,
          fairy: 2,
        },
        poison: {
          grass: 0.5,
          fighting: 0.5,
          poison: 0.5,
          ground: 2,
          psychic: 2,
          bug: 0.5,
          fairy: 0.5,
        },
        ground: {
          water: 2,
          grass: 2,
          electric: 0,
          ice: 2,
          poison: 0.5,
          rock: 0.5,
        },
        flying: {
          grass: 0.5,
          electric: 2,
          fighting: 0.5,
          ground: 0,
          ice: 2,
          bug: 0.5,
          rock: 2,
        },
        psychic: { fighting: 0.5, psychic: 0.5, bug: 2, ghost: 2, dark: 2 },
        bug: {
          grass: 0.5,
          fire: 2,
          fighting: 0.5,
          ground: 0.5,
          flying: 2,
          rock: 2,
        },
        rock: {
          normal: 0.5,
          fire: 0.5,
          water: 2,
          grass: 2,
          fighting: 2,
          poison: 0.5,
          ground: 2,
          flying: 0.5,
          steel: 2,
        },
        ghost: {
          normal: 0,
          fighting: 0,
          poison: 0.5,
          bug: 0.5,
          ghost: 2,
          dark: 2,
        },
        dragon: {
          fire: 0.5,
          water: 0.5,
          grass: 0.5,
          electric: 0.5,
          ice: 2,
          dragon: 2,
          fairy: 2,
        },
        dark: {
          fighting: 2,
          psychic: 0,
          bug: 2,
          ghost: 0.5,
          dark: 0.5,
          fairy: 2,
        },
        steel: {
          normal: 0.5,
          grass: 0.5,
          ice: 0.5,
          poison: 0,
          flying: 0.5,
          psychic: 0.5,
          bug: 0.5,
          rock: 0.5,
          dragon: 0.5,
          steel: 0.5,
          fairy: 0.5,
          fire: 2,
          fighting: 2,
          ground: 2,
        },
        fairy: {
          fighting: 0.5,
          poison: 2,
          bug: 0.5,
          dragon: 0,
          dark: 0.5,
          steel: 2,
        },
      };

      function getTacticalMatchups(types) {
        let multipliers = {};
        types.forEach((t) => {
          const defenders = TYPE_CHART[t];
          for (let attacker in TYPE_CHART) {
            let moveMult =
              TYPE_CHART[attacker][t] !== undefined
                ? TYPE_CHART[attacker][t]
                : 1;
            multipliers[attacker] = (multipliers[attacker] || 1) * moveMult;
          }
        });

        const quadWeak = Object.keys(multipliers).filter(
          (t) => multipliers[t] === 4,
        );
        const immune = Object.keys(multipliers).filter(
          (t) => multipliers[t] === 0,
        );

        let html = "";
        if (quadWeak.length > 0) {
          html +=
            `<div style="margin-top:8px;"><span style="color:#ff4d4d; font-weight:bold; font-size:0.7rem; text-transform:uppercase;">‚ö†Ô∏è Critical Weakness (x4):</span><br>` +
            quadWeak
              .map(
                (t) =>
                  `<span class="type-badge type-${t}" style="transform:scale(0.8); margin:2px;">${t}</span>`,
              )
              .join("") +
            `</div>`;
        }
        if (immune.length > 0) {
          html +=
            `<div style="margin-top:8px;"><span style="color:#4dff88; font-weight:bold; font-size:0.7rem; text-transform:uppercase;">üõ°Ô∏è Immunities:</span><br>` +
            immune
              .map(
                (t) =>
                  `<span class="type-badge type-${t}" style="transform:scale(0.8); margin:2px;">${t}</span>`,
              )
              .join("") +
            `</div>`;
        }
        return html;
      }
      // This function instantly swaps out the stats when a new strategy is selected from the dropdown
      function renderStrategyView(index) {
        const strat = window.currentStrategies[index];

        // Sleek Move List with crimson ">" arrows
        const movesList = strat.moves
          .map((m) => {
            const formatted = m
              .split(" / ")
              .join(
                '<span style="color: var(--text-muted); font-weight: normal; margin: 0 4px;">/</span>',
              );
            return `<li style="margin-bottom: 8px; line-height: 1.4; font-weight: bold;"><span style="color: var(--accent-primary); margin-right: 8px;">></span>${formatted}</li>`;
          })
          .join("");

        // Tera Badges
        const teraHtml = strat.teraType
          .split(" / ")
          .map(
            (t) =>
              `<span class="type-badge type-${t.toLowerCase()}" style="margin: 0 2px;">${t}</span>`,
          )
          .join("");

        const html = `
        <div>
            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; margin-bottom: 20px;">
                
                <div class="info-card" style="grid-column: span 2; margin: 0; background: rgba(0,0,0,0.3); text-align: center;">
                    <h4 style="font-size: 0.75rem;">üé≠ Nature</h4>
                    <p style="font-weight: 500;">${strat.nature}</p>
                </div>
                <div class="info-card" style="grid-column: span 2; margin: 0; background: rgba(0,0,0,0.3); text-align: center;">
                    <h4 style="font-size: 0.75rem;">‚ú® Ability</h4>
                    <p style="text-transform: capitalize; font-weight: 500;">${strat.ability}</p>
                </div>
                <div class="info-card" style="grid-column: span 2; margin: 0; background: rgba(0,0,0,0.3); text-align: center;">
                    <h4 style="font-size: 0.75rem;">üéí Held Item</h4>
                    <p style="font-weight: 500;">${strat.item}</p>
                </div>
                
                <div class="info-card" style="grid-column: span 3; margin: 0; background: rgba(0,0,0,0.3); text-align: center;">
                    <h4 style="font-size: 0.75rem;">üîÆ Tera Type</h4>
                    <div style="margin-top: 4px; display: flex; justify-content: center; flex-wrap: wrap;">${teraHtml}</div>
                </div>
                <div class="info-card" style="grid-column: span 3; margin: 0; background: rgba(0,0,0,0.3); text-align: center;">
                    <h4 style="font-size: 0.75rem;">üìä Target EVs</h4>
                    <p style="font-weight: 500; font-size: 0.9rem;">${strat.evs}</p>
                </div>

            </div>
            
            <div style="margin-bottom: 5px;">
                <h4 style="color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;">‚öîÔ∏è Required Moves</h4>
                <ul style="list-style-type: none; padding-left: 5px; text-transform: capitalize; display: grid; grid-template-columns: 1fr; gap: 6px; margin-top: 10px;">
                    ${movesList}
                </ul>
                <div style="text-align: right; margin-top: 15px;">
                    <a href="${window.smogonUrl}" target="_blank" style="font-size: 0.65rem; color: var(--accent-primary); font-weight: bold; letter-spacing: 0.5px; text-decoration: none;">
                        VIEW FULL SMOGON STRATEGY ‚Üó
                    </a>
                </div>
            </div>
        </div>
    `;

        const container = document.getElementById("dynamic-strategy-content");
        if (container) {
          container.innerHTML = html;
        }
      }
    </script>
    <footer class="footer-sources glass-panel">
      <span class="footer-label">Data Assembled From:</span>
      <div class="footer-links">
        <a
          href="https://www.lumyverse.com/cobbleverse/"
          target="_blank"
          class="source-badge"
          >Cobbleverse</a
        >
        <a href="https://cobblemon.com/" target="_blank" class="source-badge"
          >Cobblemon</a
        >
        <a href="https://www.smogon.com/" target="_blank" class="source-badge"
          >Smogon</a
        >
        <a href="https://pokeapi.co/" target="_blank" class="source-badge"
          >Pok√©API</a
        >
      </div>
    </footer>
  </body>
</html>
