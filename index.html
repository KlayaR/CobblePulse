<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CobblePulse</title>
    <style>
      /* --- CSS VARIABLES & THEME --- */
      :root {
        --bg-gradient: radial-gradient(
          circle at center,
          #1a1a2e 0%,
          #16213e 100%
        );
        --glass-bg: rgba(22, 33, 62, 0.7);
        --glass-border: rgba(255, 255, 255, 0.1);
        --accent-primary: #e94560;
        --accent-secondary: #0f3460;
        --text-main: #f5f5f5;
        --text-muted: #a0a0b5;
        --blur: blur(12px);
      }

      /* Type Colors */
      .type-normal {
        background: #a8a878;
        color: #fff;
      }
      .type-fire {
        background: #f08030;
        color: #fff;
      }
      .type-water {
        background: #6890f0;
        color: #fff;
      }
      .type-grass {
        background: #78c850;
        color: #fff;
      }
      .type-electric {
        background: #f8d030;
        color: #000;
      }
      .type-ice {
        background: #98d8d8;
        color: #000;
      }
      .type-fighting {
        background: #c03028;
        color: #fff;
      }
      .type-poison {
        background: #a040a0;
        color: #fff;
      }
      .type-ground {
        background: #e0c068;
        color: #000;
      }
      .type-flying {
        background: #a890f0;
        color: #fff;
      }
      .type-psychic {
        background: #f85888;
        color: #fff;
      }
      .type-bug {
        background: #a8b820;
        color: #fff;
      }
      .type-rock {
        background: #b8a038;
        color: #fff;
      }
      .type-ghost {
        background: #705898;
        color: #fff;
      }
      .type-dragon {
        background: #7038f8;
        color: #fff;
      }
      .type-dark {
        background: #705848;
        color: #fff;
      }
      .type-steel {
        background: #b8b8d0;
        color: #000;
      }
      .type-fairy {
        background: #ee99ac;
        color: #000;
      }

      /* --- RESET & BASE --- */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg-gradient);
        color: var(--text-main);
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 10px;
      }
      ::-webkit-scrollbar-track {
        background: #16213e;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--accent-secondary);
        border-radius: 5px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--accent-primary);
      }

      /* --- LAYOUT COMPONENTS --- */
      .glass-panel {
        background: var(--glass-bg);
        backdrop-filter: var(--blur);
        -webkit-backdrop-filter: var(--blur);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Header */
      header {
        padding: 20px;
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        align-items: center;
        justify-content: space-between;
      }
      h1 {
        font-size: 1.8rem;
        letter-spacing: 1px;
        color: var(--text-main);
      }
      h1 span {
        color: var(--accent-primary);
      }

      .controls {
        display: flex;
        gap: 15px;
        flex-grow: 1;
        justify-content: flex-end;
      }
      input,
      select {
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid var(--glass-border);
        background: rgba(0, 0, 0, 0.2);
        color: var(--text-main);
        font-size: 1rem;
        outline: none;
      }
      input:focus,
      select:focus {
        border-color: var(--accent-primary);
      }
      select option {
        background: #1a1a2e;
        color: #fff;
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        overflow-x: auto;
        padding-bottom: 5px;
      }
      .tab-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--glass-border);
        color: var(--text-muted);
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
      }
      .tab-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-main);
      }
      .tab-btn.active {
        background: var(--accent-primary);
        color: #fff;
        border-color: var(--accent-primary);
      }

      /* Main UI - Table */
      .table-container {
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        text-align: left;
      }
      th,
      td {
        padding: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }
      th {
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.9rem;
      }
      tr {
        transition: background 0.2s;
        cursor: pointer;
      }
      tr:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .sprite-cell img {
        width: 50px;
        height: 50px;
        image-rendering: pixelated;
      }
      .type-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
        margin-right: 5px;
        text-transform: capitalize;
      }

      .loading {
        text-align: center;
        padding: 50px;
        color: var(--text-muted);
        font-size: 1.2rem;
      }

      /* --- MODAL --- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        z-index: 1000;
        padding: 20px;
      }
      .modal-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }

      .modal-content {
        width: 100%;
        max-width: 600px;
        padding: 30px;
        position: relative;
        transform: translateY(20px);
        transition: transform 0.3s ease;
        max-height: 90vh;
        overflow-y: auto;
      }
      .modal-overlay.active .modal-content {
        transform: translateY(0);
      }

      .close-btn {
        position: absolute;
        top: 15px;
        right: 20px;
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 1.5rem;
        cursor: pointer;
        transition: color 0.2s;
      }
      .close-btn:hover {
        color: var(--accent-primary);
      }

      .modal-header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 25px;
        border-bottom: 1px solid var(--glass-border);
        padding-bottom: 20px;
      }
      .modal-sprite {
        width: 120px;
        height: 120px;
        image-rendering: pixelated;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 50%;
      }
      .modal-title h2 {
        font-size: 2rem;
        text-transform: capitalize;
        margin-bottom: 5px;
      }
      .tier-badge {
        background: var(--accent-secondary);
        color: #fff;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        vertical-align: middle;
        margin-left: 10px;
      }

      .modal-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
      }
      .info-card {
        background: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid var(--glass-border);
      }
      .info-card h4 {
        color: var(--text-muted);
        font-size: 0.85rem;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .full-width {
        grid-column: 1 / -1;
      }

      @media (max-width: 600px) {
        .controls {
          flex-direction: column;
          width: 100%;
        }
      }

      /* --- THE PULSE ANIMATION --- */
      @keyframes pulse-glow {
        0% {
          text-shadow: 0 0 5px rgba(233, 69, 96, 0.2);
        }
        50% {
          text-shadow:
            0 0 15px rgba(233, 69, 96, 0.6),
            0 0 25px rgba(233, 69, 96, 0.2);
        }
        100% {
          text-shadow: 0 0 5px rgba(233, 69, 96, 0.2);
        }
      }

      header h1 {
        font-family: "Inter", sans-serif;
        letter-spacing: -1px;
        font-weight: 800;
        font-size: 2.5rem;
        background: linear-gradient(to right, #fff, var(--accent-primary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: pulse-glow 3s infinite ease-in-out;
        margin-bottom: 5px;
      }

      /* --- MESH BACKGROUND --- */
      body {
        background: radial-gradient(
          circle at top right,
          #1a1a2e,
          #16213e,
          #0f3460
        );
        background-attachment: fixed;
      }

      /* --- STATS SUBHEADER --- */
      .stats-bar {
        display: flex;
        justify-content: center;
        gap: 20px;
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 30px;
      }

      .stats-item span {
        color: var(--accent-primary);
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container" id="app">
      <header>
        <h1>CobblePulse</h1>

        <div class="controls">
          <input
            type="text"
            id="searchInput"
            placeholder="Search by name or Dex ID..."
          />
          <select id="typeFilter">
            <option value="all">All Types</option>
          </select>
        </div>
      </header>

      <div class="tabs" id="tabContainer">
        <button class="tab-btn" data-tab="ubers">Ubers</button>
        <button class="tab-btn" data-tab="ou">OU</button>
        <button class="tab-btn" data-tab="uu">UU</button>
        <button class="tab-btn" data-tab="ru">RU</button>
        <button class="tab-btn active" data-tab="all">All Cobblemon</button>
      </div>

      <div class="glass-panel table-container">
        <table>
          <thead>
            <tr>
              <th>Rank / Dex #</th>
              <th>Sprite</th>
              <th>Name</th>
              <th>Types</th>
            </tr>
          </thead>
          <tbody id="pokemonList">
            <tr>
              <td colspan="4" class="loading">Loading Pok√©dex Data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
      <div class="modal-content glass-panel" id="modalContent">
        <button class="close-btn" id="closeBtn">&times;</button>
        <div id="modalBody"></div>
      </div>
    </div>

    <script>
      // --- STATE ---
      let allPokemon = [];
      let localDB = {};
      let currentTab = "all";

      const DOM = {
        list: document.getElementById("pokemonList"),
        searchInput: document.getElementById("searchInput"),
        typeFilter: document.getElementById("typeFilter"),
        tabs: document.querySelectorAll(".tab-btn"),
        modalOverlay: document.getElementById("modalOverlay"),
        modalBody: document.getElementById("modalBody"),
        closeBtn: document.getElementById("closeBtn"),
      };

      const POKEMON_TYPES = [
        "normal",
        "fire",
        "water",
        "grass",
        "electric",
        "ice",
        "fighting",
        "poison",
        "ground",
        "flying",
        "psychic",
        "bug",
        "rock",
        "ghost",
        "dragon",
        "dark",
        "steel",
        "fairy",
      ];

      async function init() {
        populateTypeFilter();
        setupEventListeners();

        try {
          const dbResponse = await fetch("./cobbleverse_data.json");
          localDB = await dbResponse.json();
        } catch (e) {
          console.error("Make sure you are running a local server.", e);
        }

        await fetchAllPokemon();
        applyFilters();
      }

      async function fetchAllPokemon() {
        try {
          const response = await fetch(
            "https://pokeapi.co/api/v2/pokemon?limit=1025",
          );
          const data = await response.json();

          allPokemon = data.results.map((p, index) => {
            const id = index + 1;
            const cleanName = p.name.replace("-", "");
            return {
              id: id,
              name: p.name,
              cleanName: cleanName,
              sprite: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`,
              types: [],
            };
          });
        } catch (error) {
          DOM.list.innerHTML = `<tr><td colspan="4" class="loading">Error loading PokeAPI data.</td></tr>`;
        }
      }

      async function getPokemonDetails(id) {
        const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
        return await res.json();
      }

      // --- HELPER: BUILD SPREADSHEET LOCATION UI ---
      function buildLocationCards(locations, title) {
        const cards = locations
          .map((loc) => {
            const conditionHtml = loc.condition
              ? `<div style="margin-top: 6px; color: var(--accent-primary);">‚ö†Ô∏è Condition: ${loc.condition}</div>`
              : "";
            const formsHtml = loc.forms
              ? `<div style="margin-top: 4px; color: #a8a878;">‚ú® Form Info: ${loc.forms}</div>`
              : "";

            return `
            <div style="background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-left: 3px solid var(--accent-primary); padding: 12px; border-radius: 6px; font-size: 0.9rem; margin-bottom: 8px;">
                <div style="font-weight: bold; color: var(--text-main); margin-bottom: 6px; font-size: 1rem;">üåç ${loc.spawn}</div>
                <div style="display: flex; flex-wrap: wrap; gap: 12px; color: var(--text-muted);">
                    <span style="background: rgba(255,255,255,0.05); padding: 2px 8px; border-radius: 4px;">üéØ Rarity: <strong>${loc.rarity}</strong></span>
                </div>
                ${conditionHtml}
                ${formsHtml}
            </div>
            `;
          })
          .join("");

        return `
            <h4 style="color: var(--accent-primary); margin-bottom: 12px; margin-top: 15px;">${title}</h4>
            <div style="max-height: 250px; overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column;">
                ${cards}
            </div>
        `;
      }

      async function renderTable(pokemonArray) {
        // Show a loading state while the browser prepares the massive list
        DOM.list.innerHTML = `<tr><td colspan="4" class="loading">Loading All Pok√©mon...</td></tr>`;

        let html = "";
        // REMOVED SLICE: Now loops through the entire array (1,025+ items)
        for (let i = 0; i < pokemonArray.length; i++) {
          const p = pokemonArray[i];

          if (p.types.length === 0) {
            try {
              const details = await getPokemonDetails(p.id);
              p.types = details.types.map((t) => t.type.name);
            } catch (e) {
              p.types = ["normal"];
            }
          }

          const typeHtml = p.types
            .map((t) => `<span class="type-badge type-${t}">${t}</span>`)
            .join("");

          const dbEntry = localDB[p.cleanName] || localDB[p.name];
          const rank = dbEntry && dbEntry.rank ? dbEntry.rank : 0;

          const isCompetitiveTab = currentTab !== "all";
          const rankText = isCompetitiveTab ? `Rank #${rank}` : `Dex #${p.id}`;
          const rankColor = isCompetitiveTab
            ? "var(--accent-primary)"
            : "var(--text-muted)";

          html += `
            <tr onclick="openModal(${p.id}, '${p.cleanName}')">
                <td><strong style="color: ${rankColor};">${rankText}</strong></td>
                <td class="sprite-cell"><img src="${p.sprite}" alt="${p.name}" loading="lazy"></td>
                <td style="text-transform: capitalize; font-weight: bold;">${p.name.replace("-", " ")}</td>
                <td>${typeHtml}</td>
            </tr>
        `;
        }

        if (pokemonArray.length === 0) {
          html = `<tr><td colspan="4" class="loading">No Pok√©mon found.</td></tr>`;
        }

        // Injects the entire list into the DOM at once
        DOM.list.innerHTML = html;
      }

      function applyFilters() {
        const query = DOM.searchInput.value.toLowerCase();
        const typeFilter = DOM.typeFilter.value;

        let filtered = [];

        if (currentTab === "all") {
          filtered = allPokemon;
        } else {
          filtered = allPokemon.filter((p) => {
            const dbEntry = localDB[p.cleanName] || localDB[p.name];
            return (
              dbEntry &&
              dbEntry.tier &&
              (dbEntry.tier.toLowerCase() === currentTab ||
                (currentTab === "ubers" &&
                  dbEntry.tier.toLowerCase() === "uber")) &&
              dbEntry.rank
            );
          });

          filtered.sort((a, b) => {
            const rankA = (localDB[a.cleanName] || localDB[a.name]).rank;
            const rankB = (localDB[b.cleanName] || localDB[b.name]).rank;
            return rankA - rankB;
          });

          // REMOVE THIS LINE IF IT EXISTS:
          // filtered = filtered.slice(0, 30);
        }

        if (query) {
          filtered = filtered.filter((p) => {
            const dbEntry = localDB[p.cleanName] || localDB[p.name] || {};
            const source = (dbEntry.source || "").toLowerCase();

            return (
              p.name.includes(query) ||
              p.id.toString() === query ||
              source.includes(query)
            ); // Now searches the Mod Source too!
          });
        }

        if (typeFilter !== "all") {
          filtered = filtered.filter(
            (p) => p.types.includes(typeFilter) || p.types.length === 0,
          );
        }

        renderTable(filtered);
      }

      function populateTypeFilter() {
        POKEMON_TYPES.forEach((type) => {
          const option = document.createElement("option");
          option.value = type;
          option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
          DOM.typeFilter.appendChild(option);
        });
      }

      // --- MODAL WITH REDESIGNED GRID ---
      async function openModal(id, cleanName) {
        DOM.modalOverlay.classList.add("active");
        DOM.modalBody.innerHTML = `<div class="loading">Fetching Data...</div>`;

        try {
          const details = await getPokemonDetails(id);
          const speciesRes = await fetch(
            `https://pokeapi.co/api/v2/pokemon-species/${id}`,
          );
          const speciesData = await speciesRes.json();

          const dbEntry = localDB[cleanName] ||
            localDB[details.name] || { tier: "Untiered", locations: [] };
          const typeHtml = details.types
            .map(
              (t) =>
                `<span class="type-badge type-${t.type.name}">${t.type.name}</span>`,
            )
            .join("");

          // --- 1. NEW 2-COLUMN COMPETITIVE LAYOUT (CLICKABLE) ---
          // --- 1. RESTORED 2-COLUMN COMPETITIVE LAYOUT (WITH GHOST LINK) ---
          let compHtml = "";
          if (dbEntry.competitive) {
            const smogonName = details.name.replace("-", "_");
            const smogonUrl = `https://www.smogon.com/dex/sv/pokemon/${smogonName}/`;
            const movesList = dbEntry.competitive.moves
              .map((m) => `<li style="margin-bottom: 4px;">${m}</li>`)
              .join("");

            compHtml = `
                    <div style="position: relative; cursor: pointer; transition: opacity 0.2s;" class="smogon-container">
                        <a href="${smogonUrl}" target="_blank" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;"></a>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div class="info-card" style="margin: 0;">
                                <h4>üìà Usage</h4>
                                <p>${dbEntry.competitive.usage}%</p>
                            </div>
                            <div class="info-card" style="margin: 0;">
                                <h4>‚ú® Ability</h4>
                                <p style="text-transform: capitalize;">${dbEntry.competitive.ability}</p>
                            </div>
                            <div class="info-card" style="margin: 0;">
                                <h4>üé≠ Nature</h4>
                                <p>${dbEntry.competitive.nature}</p>
                            </div>
                            <div class="info-card" style="margin: 0;">
                                <h4>üìä Target EVs</h4>
                                <p>${dbEntry.competitive.evs}</p>
                            </div>
                        </div>
                        <div class="info-card full-width" style="margin-bottom: 20px; position: relative;">
                            <h4>‚öîÔ∏è Best 4 Moves</h4>
                            <ul style="list-style-position: inside; text-transform: capitalize; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                                ${movesList}
                            </ul>
                            <div style="text-align: right; font-size: 0.65rem; color: var(--accent-primary); margin-top: 8px; font-weight: bold; letter-spacing: 0.5px;">
                                VIEW FULL SMOGON STRATEGY ‚Üó
                            </div>
                        </div>
                    </div>
                `;
          } else {
            // Fallback for Pokemon with no Smogon data
            compHtml = `
            <div class="info-card full-width" style="margin-bottom: 20px; text-align: center; padding: 20px;">
                <p style="color: var(--text-muted);">No competitive Smogon data available for this Pok√©mon.</p>
            </div>
        `;
          }

          // --- 2. BUILD LOCATION HTML ---
          let locationsHtml = "";
          const hasOwnSpawns =
            dbEntry.locations && dbEntry.locations.length > 0;

          if (hasOwnSpawns) {
            locationsHtml += buildLocationCards(
              dbEntry.locations,
              "üìç Server Spawn Locations",
            );
          }

          if (
            !hasOwnSpawns &&
            (speciesData.is_legendary || speciesData.is_mythical)
          ) {
            locationsHtml += `
                    <div style="background: rgba(233, 69, 96, 0.1); border: 1px solid var(--accent-primary); padding: 15px; border-radius: 8px; margin-top: 10px;">
                        <h4 style="color: var(--accent-primary); margin-bottom: 8px;">‚ú® Legendary Summoning</h4>
                        <p style="color: var(--text-main); font-size: 0.95rem; line-height: 1.4;">This Pok√©mon does not spawn naturally in the wild. You must use a specialized summoning item at an altar, or participate in a server event.</p>
                    </div>
                `;
          } else if (speciesData.evolves_from_species) {
            const chainRes = await fetch(speciesData.evolution_chain.url);
            const chainData = await chainRes.json();

            const baseEvoName = chainData.chain.species.name;
            const cleanBaseEvoName = baseEvoName.replace("-", "");
            const baseEvoDb = localDB[cleanBaseEvoName] || localDB[baseEvoName];

            const hasBaseEvoSpawns =
              baseEvoDb &&
              baseEvoDb.locations &&
              baseEvoDb.locations.length > 0;

            if (hasBaseEvoSpawns) {
              const title = hasOwnSpawns
                ? `üí° Easier to catch base form: ${baseEvoName.toUpperCase()}`
                : `üß¨ Evolves from ${baseEvoName.toUpperCase()} (Spawns Below)`;

              locationsHtml += buildLocationCards(baseEvoDb.locations, title);
            } else if (!hasOwnSpawns) {
              locationsHtml += `<p style="color: var(--text-muted); margin-top: 10px;">Must be evolved from <strong>${baseEvoName.toUpperCase()}</strong>. No wild spawns found.</p>`;
            }
          } else if (!hasOwnSpawns) {
            locationsHtml +=
              '<p style="color: var(--text-muted); margin-top: 10px;">No wild spawns found on this server. (Check server shops, fossils, or special events).</p>';
          }

          // --- 3. FINAL INJECTION (With Discrete Source) ---
          const pokemonDbUrl = `https://pokemondb.net/pokedex/${details.name}`;

          // Subtle Source Tag
          const sourceTag = dbEntry.source
            ? `<span style="font-size: 0.7rem; color: var(--text-muted); opacity: 0.6; margin-left: 8px; text-transform: uppercase; letter-spacing: 1px;">[Source: ${dbEntry.source}]</span>`
            : "";

          DOM.modalBody.innerHTML = `
                <div class="modal-header">
                    <img src="${details.sprites.front_default}" alt="${details.name}" class="modal-sprite">
                    <div class="modal-title">
                        <h2 style="margin-bottom: 5px; display: flex; align-items: center; flex-wrap: wrap;">
                            <a href="${pokemonDbUrl}" target="_blank" title="View on PokemonDB" 
                               style="color: var(--text-main); text-decoration: none; transition: color 0.2s;">
                               ${details.name.replace("-", " ")}
                            </a>
                            <span class="tier-badge">${dbEntry.tier}</span>
                            ${sourceTag}
                        </h2>
                        <div style="margin-top: 5px;">${typeHtml}</div>
                    </div>
                </div>
                <div>
                    ${compHtml}
                    <div class="info-card full-width" style="border-color: var(--accent-primary);">
                        ${locationsHtml}
                    </div>
                </div>
            `;
        } catch (e) {
          console.error(e);
          DOM.modalBody.innerHTML = `<div class="loading">Failed to load details.</div>`;
        }
      }

      function closeModal() {
        DOM.modalOverlay.classList.remove("active");
      }

      function setupEventListeners() {
        let timeout = null;
        DOM.searchInput.addEventListener("input", () => {
          clearTimeout(timeout);
          timeout = setTimeout(applyFilters, 300);
        });

        DOM.typeFilter.addEventListener("change", applyFilters);

        DOM.tabs.forEach((tab) => {
          tab.addEventListener("click", (e) => {
            DOM.tabs.forEach((t) => t.classList.remove("active"));
            e.target.classList.add("active");
            currentTab = e.target.getAttribute("data-tab");
            applyFilters();
          });
        });

        DOM.closeBtn.addEventListener("click", closeModal);
        DOM.modalOverlay.addEventListener("click", (e) => {
          if (e.target === DOM.modalOverlay) closeModal();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeModal();
        });
      }

      init();

      const TYPE_CHART = {
        normal: { ghost: 0, fighting: 2 },
        fire: {
          fire: 0.5,
          water: 2,
          grass: 0.5,
          ice: 0.5,
          ground: 2,
          rock: 2,
          bug: 0.5,
          steel: 0.5,
          fairy: 0.5,
        },
        water: {
          fire: 0.5,
          water: 0.5,
          grass: 2,
          electric: 2,
          ice: 0.5,
          steel: 0.5,
        },
        grass: {
          fire: 2,
          water: 0.5,
          grass: 0.5,
          electric: 0.5,
          ice: 2,
          poison: 2,
          ground: 0.5,
          flying: 2,
          bug: 2,
        },
        electric: { electric: 0.5, ground: 2, flying: 0.5, steel: 0.5 },
        ice: { fire: 2, water: 1, ice: 0.5, fighting: 2, rock: 2, steel: 2 },
        fighting: {
          flying: 2,
          psychic: 2,
          bug: 0.5,
          rock: 0.5,
          dark: 0.5,
          fairy: 2,
        },
        poison: {
          grass: 0.5,
          fighting: 0.5,
          poison: 0.5,
          ground: 2,
          psychic: 2,
          bug: 0.5,
          fairy: 0.5,
        },
        ground: {
          water: 2,
          grass: 2,
          electric: 0,
          ice: 2,
          poison: 0.5,
          rock: 0.5,
        },
        flying: {
          grass: 0.5,
          electric: 2,
          fighting: 0.5,
          ground: 0,
          ice: 2,
          bug: 0.5,
          rock: 2,
        },
        psychic: { fighting: 0.5, psychic: 0.5, bug: 2, ghost: 2, dark: 2 },
        bug: {
          grass: 0.5,
          fire: 2,
          fighting: 0.5,
          ground: 0.5,
          flying: 2,
          rock: 2,
        },
        rock: {
          normal: 0.5,
          fire: 0.5,
          water: 2,
          grass: 2,
          fighting: 2,
          poison: 0.5,
          ground: 2,
          flying: 0.5,
          steel: 2,
        },
        ghost: {
          normal: 0,
          fighting: 0,
          poison: 0.5,
          bug: 0.5,
          ghost: 2,
          dark: 2,
        },
        dragon: {
          fire: 0.5,
          water: 0.5,
          grass: 0.5,
          electric: 0.5,
          ice: 2,
          dragon: 2,
          fairy: 2,
        },
        dark: {
          fighting: 2,
          psychic: 0,
          bug: 2,
          ghost: 0.5,
          dark: 0.5,
          fairy: 2,
        },
        steel: {
          normal: 0.5,
          grass: 0.5,
          ice: 0.5,
          poison: 0,
          flying: 0.5,
          psychic: 0.5,
          bug: 0.5,
          rock: 0.5,
          dragon: 0.5,
          steel: 0.5,
          fairy: 0.5,
          fire: 2,
          fighting: 2,
          ground: 2,
        },
        fairy: {
          fighting: 0.5,
          poison: 2,
          bug: 0.5,
          dragon: 0,
          dark: 0.5,
          steel: 2,
        },
      };

      function getTacticalMatchups(types) {
        let multipliers = {};
        types.forEach((t) => {
          const defenders = TYPE_CHART[t];
          for (let attacker in TYPE_CHART) {
            let moveMult =
              TYPE_CHART[attacker][t] !== undefined
                ? TYPE_CHART[attacker][t]
                : 1;
            multipliers[attacker] = (multipliers[attacker] || 1) * moveMult;
          }
        });

        const quadWeak = Object.keys(multipliers).filter(
          (t) => multipliers[t] === 4,
        );
        const immune = Object.keys(multipliers).filter(
          (t) => multipliers[t] === 0,
        );

        let html = "";
        if (quadWeak.length > 0) {
          html +=
            `<div style="margin-top:8px;"><span style="color:#ff4d4d; font-weight:bold; font-size:0.7rem; text-transform:uppercase;">‚ö†Ô∏è Critical Weakness (x4):</span><br>` +
            quadWeak
              .map(
                (t) =>
                  `<span class="type-badge type-${t}" style="transform:scale(0.8); margin:2px;">${t}</span>`,
              )
              .join("") +
            `</div>`;
        }
        if (immune.length > 0) {
          html +=
            `<div style="margin-top:8px;"><span style="color:#4dff88; font-weight:bold; font-size:0.7rem; text-transform:uppercase;">üõ°Ô∏è Immunities:</span><br>` +
            immune
              .map(
                (t) =>
                  `<span class="type-badge type-${t}" style="transform:scale(0.8); margin:2px;">${t}</span>`,
              )
              .join("") +
            `</div>`;
        }
        return html;
      }
    </script>
  </body>
</html>
